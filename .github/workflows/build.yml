name: Build NixOS ISO

on:
  push:
    branches:
      - main
    paths:
      - flake.nix
      - flake.lock
      - configuration.nix

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install Nix
        run: |
          sh <(curl -L https://nixos.org/nix/install) --daemon
          echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf

      - name: Generate version number
        id: version
        run: |
          VERSION=$(date +'%y.%m').${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build ISO
        run: |
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          nix build .#packages.aarch64-linux.iso.config.system.build.isoImage --print-build-logs

      - name: Prepare ISO artifact
        run: |
          mkdir -p release
          ISO_PATH=$(readlink -f result/iso/*.iso)
          cp "$ISO_PATH" release/nixos-${{ steps.version.outputs.version }}-aarch64.iso

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create v${{ steps.version.outputs.version }} \
            --title "v${{ steps.version.outputs.version }}" \
            release/nixos-${{ steps.version.outputs.version }}-aarch64.iso

