This is a configuration for a NixOS VM used for development.

# Mind Map

> **For AI Agents:** This mind map is your primary knowledge index. Read overview nodes [1-5] first, then follow links [N] to find what you need. Always reference node IDs. When you encounter bugs, document your attempts in relevant nodes. When you make changes, update outdated nodes immediately—especially overview nodes since they're your springboard. Add new nodes only for genuinely new concepts. Keep it compact (20-50 nodes typical). The mind map wraps every task: consult it, rely on it, update it.
 
[1] **Project Overview** - This repository defines a NixOS-based development VM tailored for a Mac-hosted UTM/QEMU setup, centered on a reproducible flake and home-manager profiles [2][4][5]. The system config in configuration.nix wires services, users, and packages to support daily development and agent-driven workflows [3][20]. VM bootstrap flows rely on custom scripts (nx-install, nx-init, nx-rebuild) and a dual-ISO pipeline (installer + docker-focused image) for reproducible provisioning paths [6][7]. Developer experience focuses on curated shells, editors, tmux, workspace tooling, and per-user SSH conveniences (including `docker_host` for braden) plus a bubblewrapped agent environment backed by proxy controls [9][10][11][14][12]. Data and flake deployment, permissions, and Nix/system settings round out the environment footprint, with Docker isolated to the docker-target profile, dockeragent egress blocked at the firewall, and braden-only skopeo image pre-cache tooling for offline/rootless workflows [19][21][15]. Development history and recent changes are tracked in git and summarized in the timeline node [22].
 
[2] **Flake Architecture** - flake.nix declares nixpkgs and home-manager inputs pinned to release-25.11, producing `nixosConfigurations.default` (main VM) and `nixosConfigurations.docker` (docker-focused system) plus two ISO outputs under `packages.${system}`: `iso` and `docker-iso` [1][7][21]. A shared installer-module helper is used by both ISO outputs so each image carries the same `nx-install` disk-format/bootstrap script and embedded `/etc/nixos-config` tree, differing only by flake target (`#default` vs `#docker`) [6][7]. The default system passes specialArgs and imports configuration.nix plus home-manager modules for braden and agent profiles [3][4]. The docker system uses dedicated rootless dockeragent behavior while preserving SSH access for `braden` and now `dockeragent` (for remote Docker socket forwarding workflows) [12][20][21]. System targeting is aarch64-linux and aligns with other toolchain decisions like Kotlin LSP packaging and neovim extras [18][16].
 
[3] **System Configuration (configuration.nix)** - configuration.nix composes the VM by importing the qemu-guest profile plus internal modules for data staging, flakes, agent proxy, and profile toggles [2][19][13][8]. It defines core services like OpenSSH with strict auth, firewall ports for dev servers, PAM/systemd umask defaults, and optional nix-ld for binary compatibility [12][21]. Users, groups, and tmpfiles layout establish /var/git, /var/gw, /var/agents, and shared caches with group write semantics that are essential to workspace tools and agent dispatch [20][15][14]. System packages include custom scripts (nx-rebuild, nx-init), vim, and ghostty while boot configuration sets kernel packages and EFI settings for the VM target [6][5]. GC scheduling, timezone, and host platform complete the main system baseline, while Docker behavior is handled by the docker-specific configuration [21][1].
 
[4] **Home-Manager User Profiles** - Two home-manager modules provide per-user environments: home-braden.nix for the main user and home-agent.nix for the sandboxed agent account [2][9]. Both share common packages via modules/common-packages.nix and pull in git, zsh, and tmux modules, while braden additionally gets neovim, direnv, agent-dispatch tooling, `docker-client`, `DOCKER_HOST=ssh://docker_host`, an SSH host alias `docker_host` (10.0.2.2:5223, user dockeragent), a `docker-precache-images` helper that runs the remote braden-only cache script on the docker VM, and `~/jdks/jdk17` + `~/jdks/jdk21` symlinks for easy remote IDE JDK selection [16][10][11][14][12][21]. The agent profile adds a packaged pi-coding-agent, a slightly different tmux setup optimized for agent sessions, and managed extension sources at `/home/agent/.pi/agent/extensions/review.ts` and `/home/agent/.pi/agent/extensions/gptstatus.ts` via home-manager [11][9][14]. User-specific variables set GRADLE_USER_HOME and PNPM_HOME, which align with shared caches and bubblewrap bindings [20][14]. These profiles anchor shell behavior, editor tooling, and workflow scripts referenced throughout the system [1][17].
 
[5] **VM Setup Workflow** - README.md documents Mac-hosted UTM setup steps: booting from the ISO, running nx-install, reconfiguring the VM, and finally using nx-init after SSH access is configured [7][6]. Network port forwarding (host 5222 to guest 22) and removal of the display device are required for headless operation and align with the OpenSSH configuration in the system config [12][3]. The flow assumes the repo is cloned into /var/gw and ties directly into the worktree layout and scripts used for daily development [15][6]. This node is the entry point for rebuilding and extending the VM, especially when local overrides are added [8][1].
 
[6] **Bootstrap Scripts (nx-install, nx-init, nx-rebuild)** - configuration.nix defines nx-rebuild and nx-init scripts for in-VM use, enforcing sudo boundaries and initializing /var/git and /var/gw worktrees [3][15]. nx-init prints the exact bare clone and worktree commands to reconstruct this repository inside the VM and optionally seed local.nix overrides [8][5]. The ISO build in flake.nix installs nx-install, a partitioning and installation script that formats disks, mounts labels, and runs nixos-install with the flake entrypoint [7][2]. These scripts together provide a reproducible path from bare disk to operational dev VM and are referenced in README setup steps [5][1]. They also integrate with data/flake deployment during activation so the system is ready after a rebuild [19][3].
 
[7] **ISO Build Pipeline** - `packages.${system}.iso` and `packages.${system}.docker-iso` both build minimal installation CDs with custom kernel/zfs compatibility knobs for aarch64 guests [2][21]. Both images now share the same `nx-install` formatting/bootstrap script and include the repository at `/etc/nixos-config`, so disk partitioning/mount/copy/install flow is identical across images [6][5]. The installer target differs by output: default ISO runs `nixos-install --flake /mnt/etc/nixos#default`, docker ISO runs `...#docker` [2][3]. The docker-target system enables dedicated `dockeragent` rootless Docker while preserving SSH access for `braden` and `dockeragent`, adding firewall-level dockeragent egress denial and a braden-owned skopeo pre-cache script/policy for image seeding workflows [12][20][21]. GitHub Actions `.github/workflows/build.yml` builds both ISOs in parallel (matrix) and publishes them together in a single versioned release tag [22][1].
 
[8] **Profiles and Local Overrides** - profiles.nix defines a small profile interface (Kotlin enablement plus agent proxy exact-URL allowlist controls), and local.nix.example demonstrates how to toggle these alongside agent-dispatch env injection [18][13][14]. configuration.nix imports profiles.nix and conditionally includes a local.nix file if present, enabling private customization without forking the repo [3][6]. The profile flags are consumed by modules such as neovim.nix for language tooling and agent-proxy.nix for network policy values [16][13][18]. This mechanism offers a lightweight extension point for per-machine tweaks while keeping the main configuration deterministic [1][2]. It also documents the expected local workflow in the bootstrap scripts and README guidance [5][6].
 
[9] **Home-Manager Module Suite** - The modules/home-manager directory houses self-contained configuration chunks for git, zsh, tmux, neovim, direnv, and agent-dispatch integration [4][10]. These modules are composed by home-braden.nix and home-agent.nix to produce coherent user environments, sharing common settings while diverging where necessary [4][11]. This structure keeps shell and editor tooling declarative and makes it easy to attach new behaviors or packages [16][17]. Agent-related options and scripts live alongside user tooling to keep the workspace behavior aligned with system-level permissions and proxy settings [14][12]. The module suite is the primary place to extend developer experience without touching the base OS configuration [1][3].
 
[10] **Shell Environment and g Script** - modules/home-manager/zsh.nix sets zsh init content, umask, and starship prompt configuration while sourcing scripts/g.sh for workspace operations [9][17]. The g function manages cloning bare repos into /var/git, creating worktrees under /var/gw, adding repositories to an existing workspace, switching via fzf, and launching the agent runner [15][14]. It uses gum and fzf for prompts, and relies on git worktree mechanics and workspace metadata to standardize branch naming [15][17]. The shell setup makes these workflows accessible while aligning with tmux keybindings and user profiles [11][4]. This node bridges interactive developer UX with the underlying storage layout and agent integration [1][9].
 
[11] **Tmux Configurations** - tmux.nix provides a vi-style configuration for braden with Ctrl-b as the prefix and prefix-based `v`/`b` pane splitting, while tmux-agent.nix uses a Ctrl-a prefix and a distinct color palette for the agent account [4][9]. Both configs enable mouse support, set xterm-ghostty, configure window selection bindings, and use vi-style copy-mode, ensuring consistent navigation across sessions [10][17]. The tmux behavior is central to the launch path used by agent-dispatch and the zsh startup sequence [14][10]. These configs are the primary terminal UX touchpoint after login or agent shell start [1][4].
 
[12] **Networking, SSH, and Firewall** - configuration.nix enables OpenSSH with key-only auth, disabled root login, and explicit AllowUsers, matching the VM setup instructions and port forwarding expectations [3][5]. For operator ergonomics, braden’s home-manager profile defines an SSH alias `docker_host` that routes from the main VM to the docker VM via host gateway `10.0.2.2` on forwarded port `5223`, targeting `dockeragent` for rootless Docker access [4][21]. The docker VM SSH allowlist includes both `braden` and `dockeragent`, but firewall OUTPUT rules now drop all dockeragent-owned IPv4/IPv6 traffic to enforce zero egress while keeping braden reachable for maintenance and image seeding [21][7]. The main VM firewall opens TCP ports 3000 and 5173 to support common dev servers, aligning with the frontend workflow implied by toolchain choices [16][1]. An HTTPS MITM proxy listens on localhost:9999 with request filtering rules, and agent-dispatch wires HTTP(S) proxy envs into the sandbox [13][14]. These settings keep the VM accessible yet constrained, balancing developer access with sandboxed agent use [20][21]. Networking choices also influence the ISO bootstrap and initial configuration steps [7][6].
 
[13] **Agent Proxy Service** - modules/agent-proxy.nix runs mitmdump on 127.0.0.1:9999 as an HTTPS MITM proxy with a Python request hook [12][14]. The policy is default-deny and allows OpenAI/ChatGPT hosts, while exact allowlist URLs are now sourced from `profiles.agentProxy.allowedExactUrls` (empty by default, typically set in local.nix) [8][12][14]. The service uses a hardened systemd unit with DynamicUser and a persistent state directory for mitmproxy runtime data/certs [3][2]. This proxy layer is the primary network guardrail for agent operations and can be adjusted via module changes [12][1]. It complements Docker and other system services by keeping agent egress explicit [21][12].
 
[14] **Agent Dispatch Containerization** - modules/home-manager/agent-dispatch.nix defines the spawn-agent script which launches a bubblewrap container with bind mounts for selected workspace repos, read-only .git directories, shared caches, and now a read-only bind of `/home/agent/.pi/agent/extensions` into the sandboxed `/home/agent/.pi/agent/extensions` path so managed extension files remain available across sessions [9][15][4]. The script manages session directories under /var/agents, sets up proxy sockets with socat, and injects HTTP(S) proxy variables plus trust envs to enforce outbound routing through the local MITM proxy on port 9999 [13][12]. It also copies the mitmproxy CA cert, generates a Java truststore via keytool, and wires GRADLE_OPTS/JAVA_TOOL_OPTIONS so JVM-based tooling trusts intercepted TLS [13][18]. It mounts the agent home in a tmp dir, binds /var/flakes and /var/nxdata, and inherits extra env vars from the agentDispatch option (set in local.nix) [19][8]. Cleanup restores permissions and prompts to keep/delete the session, matching the shared group layout in /var/gw and /var/git [20][15]. This is the core mechanism for running isolated agent sessions while preserving developer control and deterministic tooling [1][4].
 
[15] **Workspace and Git Layout** - The system organizes source control using bare repos in /var/git and worktree checkouts under /var/gw, with the main worktree in /var/gw/main and additional workspaces created by the g script [10][6]. g.sh uses git worktree add to create branches per workspace, stores a .branch metadata file, and can add repos into a workspace or remove an entire workspace cleanly [10][17]. Permissions are designed to allow the agent user to access workspace files while preserving ownership for braden, and agent-dispatch temporarily adjusts ownership during sessions [20][14]. This layout underpins the VM’s multi-repo development workflow and keeps workspace management deterministic [1][3]. It also aligns with tmpfiles rules that ensure the directories exist after rebuilds [20][3].
 
[16] **Neovim and LSP Toolchain** - modules/home-manager/neovim.nix symlinks the nvim configuration directory from /var/gw/main/bradenrayhorn/nixos-dev-vm/nvim and enables neovim with a curated LSP/formatting toolset [4][9]. Extra packages include vtsls, typescript-language-server, gopls, nil, svelte-language-server, vscode-langservers-extracted, prettierd, stylua, and nixfmt, aligning editor behavior with the VM’s dev targets [17][1]. It ships custom derivations for tree-sitter-cli and kotlin-lsp, with the latter gated by the Kotlin profile flag [18][8]. This node ties editor configuration to system profiles and ensures language tooling is available without manual installs [4][2]. It is updated frequently in the git history, reflecting evolving developer needs [22][1].
 
[17] **Common Developer Packages** - modules/common-packages.nix centralizes shared CLI tooling (ripgrep, jq, curl, fzf, gum, gcc) for both braden and agent profiles [4][9]. fzf and gum are used directly by the g script and agent dispatch selection prompts, making them functional dependencies rather than optional tools [10][14]. The lightweight list keeps base system packages minimal while still enabling fast workspace navigation and scripting [1][3]. These packages also support debugging and inspection workflows that complement neovim and tmux setups [16][11]. Expanding this list is the standard path for introducing new common CLI utilities [4][9].
 
[18] **Kotlin Profile and LSP Packaging** - profiles.nix exposes profiles.kotlin.enable, and neovim.nix uses this flag to include a custom kotlin-lsp derivation that downloads JetBrains binaries and wraps the provided JRE [8][16]. The derivation handles autoPatchelf, custom install steps, and wrapper configuration to make kotlin-lsp work on aarch64 without manual setup [16][2]. local.nix.example demonstrates how to enable this profile locally, making Kotlin tooling opt-in per developer machine [8][6]. This node reflects the project’s pattern of adding specialized language support through Nix derivations instead of ad-hoc installs [1][2]. Recent commits show iterative work to stabilize this setup alongside other editor updates [22][16].
 
[19] **Data and Flake Deployment** - modules/setup-data.nix copies files from modules/data (e.g., eff_large_wordlist.txt) into /var/nxdata during activation, providing assets used by agent sessions for naming [14][15]. modules/setup-flakes.nix deploys bundled development flakes into /var/flakes, making them writable for lockfile generation and accessible to the agent container [14][6]. Both modules register tmpfiles rules to ensure target directories exist and are owned by root, keeping deployment deterministic across rebuilds [3][20]. This staged data approach keeps the VM self-contained and ensures agent workflows have immediate access to required resources [1][14]. It also supports future expansion with additional shared assets or flake templates [2][6].
 
[20] **Users, Groups, and Permissions** - configuration.nix defines braden and agent users, groups braden/agent/dev, and tmpfiles rules for /var/git, /var/gw, /var/agents, and shared caches with setgid and group-write permissions [3][15]. Home modes are tuned for privacy and collaboration (braden 700, agent 770) and are referenced in agent-dispatch cleanup to restore ownership after sessions [14][4]. This setup ensures the agent can operate in workspace trees while preserving repo ownership boundaries and enabling shared tooling caches [15][19]. It also aligns with SSH access restrictions and the overall security posture of the VM [12][3]. These permissions are a core prerequisite for the agent workflow and worktree layout to function safely [1][14].
 
[21] **Nix Settings and Docker** - configuration.nix enables nix-command and flakes, turns on nix-ld, and configures garbage collection with weekly pruning, making the system reliable for iterative rebuilds [3][2]. Docker is no longer enabled in the main VM; `configuration-docker.nix` now carries the dedicated `dockeragent` rootless-docker boot profile used for the docker ISO and docker-target installs [7][20]. Main-VM docker usage for braden is handled via `docker-client` + `DOCKER_HOST=ssh://docker_host`, tunneling Docker API calls to the docker VM’s `dockeragent` rootless daemon over SSH, while firewall owner rules deny all dockeragent egress and shift external image fetching to a braden-only skopeo pre-cache script with a managed policy.json [4][12]. The boot and host platform settings ensure the VM matches aarch64 expectations, particularly for ISO builds and custom LSP packages [7][18]. This node captures the broader system service context that supports both development and container-host workflows [3][1]. It provides the infrastructure layer beneath the higher-level user and agent tooling [4][14].
 
[22] **Development History** - The repo evolved from the initial commit 930f197 (2026-01-31) establishing the base flake and VM setup into a series of rapid additions throughout early February [1][2]. Key milestones include adding the pi agent package (67d607d) and workspace tooling via the g script (58da265), followed by multiple agent-dispatch fixes and permission updates (b7e2cf6, ddd617a, 4fae5ad) that stabilized the sandbox workflow [14][10][20]. Kotlin tooling matured with commits 85dab39 and 2b848b4, and editor updates continued through 1b7e8b9 and 55a0d5b, aligning with the neovim toolchain node [16][18]. Proxy handling and env forwarding landed in 91b019a and f78830f, with current config now using mitmproxy-based filtering for host and path policy enforcement [13][12][14]. Recent tweaks include opening port 5173 (257bf77), enabling TS LSP on Svelte files (0d6b5d0), and adding a second docker-focused ISO/release path with a dedicated rootless dockeragent profile [7][21]. Total development spans 40+ commits over ~2 weeks, with changes clustering around agent workflow hardening and editor/tooling improvements [1][4].

